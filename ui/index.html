<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wallfacer — Kanban</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked@9/marked.min.js"></script>
<style>
  /* --- Theme variables --- */
  :root, [data-theme="light"] {
    --bg: #dfe2e7;
    --bg-raised: #d3d7dd;
    --bg-card: #e8eaed;
    --bg-input: #d8dce2;
    --text: #313845;
    --text-secondary: #5a6374;
    --text-muted: #8c95a4;
    --accent: #4872b5;
    --accent-hover: #345d9e;
    --border: #bcc1cb;
    --shadow: 0 1px 3px rgba(0,0,0,0.07);
    --shadow-lg: 0 8px 24px rgba(0,0,0,0.11);
  }
  [data-theme="dark"] {
    --bg: #181c22;
    --bg-raised: #1f242c;
    --bg-card: #252b34;
    --bg-input: #1c2028;
    --text: #dde2ea;
    --text-secondary: #8e9baf;
    --text-muted: #5c6878;
    --accent: #5b8fd4;
    --accent-hover: #82aae0;
    --border: #2e3644;
    --shadow: 0 1px 3px rgba(0,0,0,0.25);
    --shadow-lg: 0 8px 24px rgba(0,0,0,0.45);
  }

  ::selection { background: #555; color: #fff; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    line-height: 1.6;
  }

  /* --- Layout --- */
  .column { flex: 1; min-height: 0; overflow-y: auto; }
  .col-bg { background: var(--bg-raised); border-radius: 12px; padding: 12px; }

  /* --- Cards --- */
  .card {
    cursor: grab;
    transition: transform 0.15s, box-shadow 0.15s;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px;
  }
  .card:hover { transform: translateY(-1px); box-shadow: var(--shadow-lg); }
  .card.sortable-ghost { opacity: 0.4; }
  .card.sortable-chosen { box-shadow: var(--shadow-lg); }

  /* --- Badges --- */
  .badge { padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 500; }
  .badge-backlog { background: #d0d4db; color: #6b7584; }
  .badge-in_progress { background: #cfddf5; color: #2c5b9a; }
  .badge-waiting { background: #f0e6ce; color: #7a5810; }
  .badge-committing { background: #f0e6ce; color: #7a5810; }
  .badge-done { background: #cceadb; color: #1a6638; }
  .badge-failed { background: #f0d3d3; color: #8c2424; }
  .badge-archived { background: #d0d4db; color: #6b7584; font-style: italic; }
  [data-theme="dark"] .badge-backlog { background: #2a3040; color: #7a8899; }
  [data-theme="dark"] .badge-in_progress { background: #1a2d4a; color: #6da0dc; }
  [data-theme="dark"] .badge-waiting { background: #352a10; color: #d4a030; }
  [data-theme="dark"] .badge-committing { background: #352a10; color: #d4a030; }
  [data-theme="dark"] .badge-done { background: #0e2e1e; color: #45b87a; }
  [data-theme="dark"] .badge-failed { background: #341414; color: #d46868; }
  [data-theme="dark"] .badge-archived { background: #2a3040; color: #7a8899; font-style: italic; }

  /* --- Spinner --- */
  .spinner {
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%; width: 16px; height: 16px;
    animation: spin 0.8s linear infinite; display: inline-block;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* --- Modal --- */
  .modal-overlay { background: rgba(0,0,0,0.3); backdrop-filter: blur(4px); }
  [data-theme="dark"] .modal-overlay { background: rgba(0,0,0,0.6); }
  .modal-card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 16px; max-width: 672px; width: 100%;
    max-height: 95vh; overflow-y: auto; box-shadow: var(--shadow-lg);
  }

  /* --- Column headers --- */
  .col-header { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
  .col-header-backlog { color: var(--text-muted); }
  .col-header-progress { color: #3a6db3; }
  .col-header-waiting { color: #a07020; }
  .col-header-done { color: #28804a; }
  .col-header-failed { color: #a02828; }
  [data-theme="dark"] .col-header-progress { color: #6da0dc; }
  [data-theme="dark"] .col-header-waiting { color: #d4a030; }
  [data-theme="dark"] .col-header-done { color: #45b87a; }
  [data-theme="dark"] .col-header-failed { color: #d46868; }

  /* --- Event type colors --- */
  .ev-state { color: #3a6db3; }
  .ev-output { color: #28804a; }
  .ev-feedback { color: #a07020; }
  .ev-error { color: #b02828; }
  [data-theme="dark"] .ev-state { color: #6da0dc; }
  [data-theme="dark"] .ev-output { color: #45b87a; }
  [data-theme="dark"] .ev-feedback { color: #d4a030; }
  [data-theme="dark"] .ev-error { color: #d46868; }

  /* --- Form elements --- */
  .field {
    background: var(--bg-input); border: 1px solid var(--border); color: var(--text);
    border-radius: 8px; padding: 12px; font-size: 14px; outline: none; width: 100%;
    font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace; resize: none;
    box-sizing: border-box;
  }
  .field::placeholder { color: var(--text-muted); }
  .field:focus { border-color: var(--accent); }

  .select {
    background: var(--bg-input); border: 1px solid var(--border); color: var(--text-secondary);
    border-radius: 4px; padding: 4px 8px; font-size: 12px; outline: none;
  }
  .select:focus { border-color: var(--accent); }

  /* --- Buttons --- */
  .btn { border: none; border-radius: 8px; padding: 6px 16px; font-size: 14px; font-weight: 500; cursor: pointer; }
  .btn-accent { background: var(--accent); color: #fff; }
  .btn-accent:hover { background: var(--accent-hover); }
  .btn-yellow { background: #a07020; color: #fff; }
  .btn-yellow:hover { background: #7a5518; }
  .btn-green { background: #28804a; color: #fff; }
  .btn-green:hover { background: #1f6438; }
  .btn-ghost { background: transparent; color: var(--text-muted); border: none; padding: 6px 16px; font-size: 14px; cursor: pointer; }
  .btn-ghost:hover { color: var(--text); }
  .btn-dashed {
    width: 100%; border: 1px dashed var(--border); border-radius: 8px;
    padding: 8px 12px; font-size: 14px; color: var(--text-muted);
    background: transparent; cursor: pointer;
  }
  .btn-dashed:hover { color: var(--text-secondary); border-color: var(--text-muted); }
  .btn-danger { color: #b02828; background: none; border: none; cursor: pointer; font-size: 14px; }
  .btn-danger:hover { color: #8c1e1e; }
  [data-theme="dark"] .btn-danger { color: #d46868; }
  [data-theme="dark"] .btn-danger:hover { color: #e08888; }

  /* --- Code / log blocks --- */
  pre { white-space: pre-wrap; word-break: break-word; }
  .code-block {
    background: var(--bg-input); border-radius: 8px; padding: 16px;
    font-size: 14px; color: var(--text-secondary);
  }
  .logs-block {
    background: #0d1117; border-radius: 8px; padding: 16px;
    font-size: 12px; color: #4ade80; max-height: 384px;
    overflow-y: auto; font-family: 'SF Mono', 'Fira Code', monospace;
  }

  /* --- Usage stats --- */
  .usage-grid {
    background: var(--bg-input); border-radius: 8px; padding: 16px;
    display: grid; grid-template-columns: 1fr 1fr; gap: 4px 24px; font-size: 14px;
  }
  .usage-label { color: var(--text-muted); }
  .usage-value { color: var(--text); font-family: 'SF Mono', 'Fira Code', monospace; text-align: right; }

  /* --- Settings panel --- */
  .settings-panel {
    position: absolute; top: 100%; right: 0; margin-top: 8px;
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 12px; padding: 16px; min-width: 200px;
    box-shadow: var(--shadow-lg); z-index: 100;
  }
  .settings-btn {
    background: none; border: none; color: var(--text-muted);
    cursor: pointer; padding: 6px; display: flex; align-items: center;
    border-radius: 6px;
  }
  .settings-btn:hover { color: var(--text); }

  .theme-switch {
    display: flex; background: var(--bg-input); border: 1px solid var(--border);
    border-radius: 8px; overflow: hidden;
  }
  .theme-switch button {
    flex: 1; padding: 6px 0; font-size: 12px; font-weight: 500;
    background: transparent; color: var(--text-muted);
    border: none; cursor: pointer;
  }
  .theme-switch button.active { background: var(--accent); color: #fff; }
  .theme-switch button:hover:not(.active) { color: var(--text); }

  /* --- Utility --- */
  .text-v-primary { color: var(--text); }
  .text-v-secondary { color: var(--text-secondary); }
  .text-v-muted { color: var(--text-muted); }
  .border-v { border-color: var(--border); }
  .section-title { font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 8px; }

  /* --- Icon buttons (toggle/copy) --- */
  .btn-icon {
    background: none; border: 1px solid var(--border); color: var(--text-muted);
    border-radius: 5px; padding: 2px 7px; font-size: 11px; cursor: pointer;
    display: inline-flex; align-items: center; gap: 3px; line-height: 1.6;
  }
  .btn-icon:hover { color: var(--text); border-color: var(--text-muted); }

  /* --- Markdown prose (modal detail view) --- */
  .prose-content { font-size: 14px; line-height: 1.6; color: var(--text-secondary); }
  .prose-content h1, .prose-content h2, .prose-content h3,
  .prose-content h4, .prose-content h5, .prose-content h6 {
    font-weight: 600; line-height: 1.3; color: var(--text); margin: 0.75em 0 0.3em;
  }
  .prose-content h1 { font-size: 1.25em; }
  .prose-content h2 { font-size: 1.1em; }
  .prose-content h3 { font-size: 1em; }
  .prose-content p { margin: 0.4em 0; }
  .prose-content p:first-child { margin-top: 0; }
  .prose-content p:last-child { margin-bottom: 0; }
  .prose-content ul, .prose-content ol { padding-left: 1.5em; margin: 0.4em 0; }
  .prose-content li { margin: 0.15em 0; }
  .prose-content code {
    background: var(--bg); border-radius: 4px; padding: 1px 5px; font-size: 0.88em;
    font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace; color: var(--text);
  }
  .prose-content pre {
    background: var(--bg); border-radius: 6px; padding: 12px; overflow-x: auto;
    margin: 0.5em 0; font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
    font-size: 13px; white-space: pre-wrap; word-break: break-word;
  }
  .prose-content pre code { background: none; padding: 0; font-size: inherit; }
  .prose-content blockquote {
    border-left: 3px solid var(--border); padding-left: 1em;
    color: var(--text-muted); margin: 0.5em 0;
  }
  .prose-content a { color: var(--accent); text-decoration: none; }
  .prose-content a:hover { text-decoration: underline; }
  .prose-content hr { border: none; border-top: 1px solid var(--border); margin: 0.75em 0; }
  .prose-content table { border-collapse: collapse; width: 100%; margin: 0.5em 0; font-size: 13px; }
  .prose-content th, .prose-content td { border: 1px solid var(--border); padding: 5px 10px; text-align: left; }
  .prose-content th { background: var(--bg-input); font-weight: 600; color: var(--text); }
  .prose-content strong { font-weight: 600; color: var(--text); }

  /* --- Inline markdown in card previews --- */
  .card code {
    font-family: 'SF Mono', 'Fira Code', monospace;
    font-size: 0.85em; background: var(--bg-input); border-radius: 3px; padding: 0 3px;
  }
  .card strong { font-weight: 600; }
  .card em { font-style: italic; }
  .card .card-md-raw {
    font-family: inherit; margin: 0; white-space: pre-wrap; word-break: break-word;
  }
</style>
</head>
<body class="h-screen overflow-hidden flex flex-col">

<!-- Theme init (before render to prevent flash) -->
<script>
(function() {
  var mode = localStorage.getItem('wallfacer-theme') || 'auto';
  var dark = mode === 'dark' || (mode === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);
  document.documentElement.setAttribute('data-theme', dark ? 'dark' : 'light');
})();
</script>

<!-- Header -->
<header style="border-bottom: 1px solid var(--border); padding: 16px 24px; display: flex; align-items: center; justify-content: space-between;">
  <div style="display: flex; align-items: center; gap: 16px;">
    <h1 style="font-size: 18px; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; margin: 0;">Wallfacer</h1>
    <div id="workspace-list" style="display: flex; gap: 6px; flex-wrap: wrap;"></div>
  </div>
  <div style="position: relative;">
    <button id="settings-btn" class="settings-btn" onclick="toggleSettings(event)" title="Settings">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
      </svg>
    </button>
    <div id="settings-panel" class="settings-panel hidden">
      <div style="margin-bottom: 8px; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Theme</div>
      <div class="theme-switch" id="theme-switch">
        <button data-mode="light" onclick="setTheme('light')">Light</button>
        <button data-mode="dark" onclick="setTheme('dark')">Dark</button>
        <button data-mode="auto" onclick="setTheme('auto')">Auto</button>
      </div>
      <div style="margin-top: 12px; border-top: 1px solid var(--border); padding-top: 12px;">
        <div style="margin-bottom: 8px; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Done Column</div>
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px; color: var(--text-secondary);">
          <input type="checkbox" id="show-archived-toggle" onchange="toggleShowArchived()" style="cursor: pointer; accent-color: var(--accent);">
          Show archived tasks
        </label>
      </div>
    </div>
  </div>
</header>

<!-- Board -->
<main class="grid grid-cols-5 gap-4 p-6 flex-1 min-h-0" id="board">
  <div class="flex flex-col min-h-0">
    <div class="flex items-center gap-2 mb-3 px-1">
      <h2 class="col-header col-header-backlog">Backlog</h2>
      <span id="count-backlog" class="text-xs text-v-muted">0</span>
    </div>
    <button id="new-task-btn" onclick="showNewTaskForm()" class="btn-dashed mb-2">+ New Task</button>
    <div id="new-task-form" class="hidden mb-2">
      <textarea id="new-prompt" rows="4" placeholder="Describe your task (Markdown supported)..." class="field"></textarea>
      <div class="flex items-center justify-between mt-2">
        <div class="flex items-center gap-1">
          <button onclick="createTask()" class="btn btn-accent">Save</button>
          <button onclick="hideNewTaskForm()" class="btn-ghost">Cancel</button>
        </div>
        <select id="new-timeout" class="select" title="Timeout">
          <option value="5" selected>5 min</option>
          <option value="15">15 min</option>
          <option value="30">30 min</option>
          <option value="60">1 hour</option>
          <option value="120">2 hours</option>
          <option value="360">6 hours</option>
          <option value="720">12 hours</option>
          <option value="1440">24 hours</option>
        </select>
      </div>
    </div>
    <div id="col-backlog" class="column col-bg space-y-2" data-status="backlog"></div>
  </div>
  <div class="flex flex-col min-h-0">
    <div class="flex items-center gap-2 mb-3 px-1">
      <h2 class="col-header col-header-progress">In Progress</h2>
      <span id="count-in_progress" class="text-xs text-v-muted">0</span>
    </div>
    <div id="col-in_progress" class="column col-bg space-y-2" data-status="in_progress"></div>
  </div>
  <div class="flex flex-col min-h-0">
    <div class="flex items-center gap-2 mb-3 px-1">
      <h2 class="col-header col-header-waiting">Waiting</h2>
      <span id="count-waiting" class="text-xs text-v-muted">0</span>
    </div>
    <div id="col-waiting" class="column col-bg space-y-2" data-status="waiting"></div>
  </div>
  <div class="flex flex-col min-h-0">
    <div class="flex items-center gap-2 mb-3 px-1">
      <h2 class="col-header col-header-done">Done</h2>
      <span id="count-done" class="text-xs text-v-muted">0</span>
      <span id="done-stats" class="text-[10px] text-v-muted hidden"></span>
    </div>
    <div id="col-done" class="column col-bg space-y-2" data-status="done"></div>
  </div>
  <div class="flex flex-col min-h-0">
    <div class="flex items-center gap-2 mb-3 px-1">
      <h2 class="col-header col-header-failed">Failed</h2>
      <span id="count-failed" class="text-xs text-v-muted">0</span>
    </div>
    <div id="col-failed" class="column col-bg space-y-2" data-status="failed"></div>
  </div>
</main>

<!-- Detail Modal -->
<div id="modal" class="modal-overlay fixed inset-0 z-50 hidden items-center justify-center p-4">
  <div class="modal-card">
    <div class="p-6">
      <div class="flex items-start justify-between mb-4">
        <div class="flex items-center gap-3">
          <span id="modal-badge" class="badge"></span>
          <span id="modal-time" class="text-xs text-v-muted"></span>
        </div>
        <button onclick="closeModal()" class="text-v-muted text-xl leading-none" style="background:none;border:none;cursor:pointer;font-size:20px;">&times;</button>
      </div>

      <div class="flex items-center justify-between mb-2">
        <h3 class="section-title" style="margin-bottom:0;">Prompt</h3>
        <div id="modal-prompt-actions" class="flex items-center gap-1.5 hidden">
          <button id="copy-prompt-btn" onclick="copyModalText('prompt')" class="btn-icon" title="Copy to clipboard">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
            Copy
          </button>
          <button id="toggle-prompt-btn" onclick="toggleModalSection('prompt')" class="btn-icon">Raw</button>
        </div>
      </div>
      <div id="modal-prompt-rendered" class="code-block mb-4 prose-content hidden"></div>
      <pre id="modal-prompt" class="code-block mb-4 hidden"></pre>

      <!-- Editable prompt/timeout for backlog tasks -->
      <div id="modal-edit-section" class="hidden mb-4">
        <textarea id="modal-edit-prompt" rows="4" class="field"></textarea>
        <div class="flex items-center gap-2 mt-2">
          <span id="modal-edit-status" class="text-xs text-v-muted"></span>
          <div class="ml-auto flex items-center gap-1.5">
            <label for="modal-edit-timeout" class="text-xs text-v-muted">Timeout</label>
            <select id="modal-edit-timeout" class="select">
              <option value="5">5 min</option>
              <option value="15">15 min</option>
              <option value="30">30 min</option>
              <option value="60">1 hour</option>
              <option value="120">2 hours</option>
              <option value="360">6 hours</option>
              <option value="720">12 hours</option>
              <option value="1440">24 hours</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Prompt history (collapsible) -->
      <div id="modal-history-section" class="hidden mb-4">
        <details>
          <summary class="text-sm font-medium text-v-muted" style="cursor:pointer;">Prompt History</summary>
          <div id="modal-history-list" class="mt-2 space-y-2"></div>
        </details>
      </div>

      <!-- Resume section for failed tasks with session_id -->
      <div id="modal-resume-section" class="hidden mb-4">
        <h3 class="section-title">Resume Session</h3>
        <p class="text-sm text-v-secondary mb-2">This task has an active session. Resume to continue from where it left off.</p>
        <button onclick="resumeTask()" class="btn btn-green">Resume</button>
      </div>

      <!-- Retry section for done/failed tasks -->
      <div id="modal-retry-section" class="hidden mb-4">
        <h3 class="section-title">Retry</h3>
        <textarea id="modal-retry-prompt" rows="4" class="field"></textarea>
        <button onclick="retryTask()" class="btn btn-accent mt-2">Move to Backlog</button>
      </div>

      <div id="modal-result-section" class="hidden">
        <div class="flex items-center justify-between mb-2">
          <h3 class="section-title" style="margin-bottom:0;">Result</h3>
          <div class="flex items-center gap-1.5">
            <button id="copy-result-btn" onclick="copyModalText('result')" class="btn-icon" title="Copy to clipboard">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
              Copy
            </button>
            <button id="toggle-result-btn" onclick="toggleModalSection('result')" class="btn-icon">Raw</button>
          </div>
        </div>
        <div id="modal-result-rendered" class="code-block mb-4 prose-content"></div>
        <pre id="modal-result" class="code-block mb-4 hidden"></pre>
      </div>

      <!-- Usage stats -->
      <div id="modal-usage-section" class="hidden mb-4">
        <h3 class="section-title">Usage</h3>
        <div class="usage-grid">
          <div class="flex justify-between"><span class="usage-label">Input tokens</span><span id="modal-usage-input" class="usage-value"></span></div>
          <div class="flex justify-between"><span class="usage-label">Output tokens</span><span id="modal-usage-output" class="usage-value"></span></div>
          <div class="flex justify-between"><span class="usage-label">Cache read</span><span id="modal-usage-cache-read" class="usage-value"></span></div>
          <div class="flex justify-between"><span class="usage-label">Cache creation</span><span id="modal-usage-cache-creation" class="usage-value"></span></div>
          <div class="flex justify-between" style="grid-column: span 2; padding-top: 4px; border-top: 1px solid var(--border); margin-top: 4px;"><span class="usage-label">Cost</span><span id="modal-usage-cost" class="usage-value"></span></div>
        </div>
      </div>

      <!-- Live logs for in-progress tasks -->
      <div id="modal-logs-section" class="hidden mb-4">
        <h3 class="section-title">Live Output</h3>
        <pre id="modal-logs" class="logs-block"></pre>
      </div>

      <!-- Feedback form for waiting tasks -->
      <div id="modal-feedback-section" class="hidden mb-4">
        <h3 class="section-title">Provide Feedback</h3>
        <textarea id="modal-feedback" rows="3" placeholder="Type your response..." class="field"></textarea>
        <div class="flex items-center gap-2 mt-2">
          <button onclick="submitFeedback()" class="btn btn-yellow">Submit Feedback</button>
          <button onclick="completeTask()" class="btn btn-green">Mark as Done</button>
        </div>
      </div>

      <!-- Events timeline -->
      <h3 class="section-title">Events</h3>
      <div id="modal-events" class="space-y-2"></div>

      <!-- Archive section (done tasks only, not yet archived) -->
      <div id="modal-archive-section" class="hidden mb-4">
        <h3 class="section-title">Archive</h3>
        <p class="text-sm text-v-secondary mb-2">Hide this task from the Done column. It can be restored from Settings &rarr; Show archived tasks.</p>
        <button onclick="archiveTask()" class="btn btn-ghost" style="border: 1px solid var(--border);">Archive task</button>
      </div>

      <!-- Unarchive section (archived done tasks) -->
      <div id="modal-unarchive-section" class="hidden mb-4">
        <h3 class="section-title">Archived</h3>
        <p class="text-sm text-v-secondary mb-2">This task is archived and hidden from the Done column by default.</p>
        <button onclick="unarchiveTask()" class="btn btn-ghost" style="border: 1px solid var(--border);">Unarchive task</button>
      </div>

      <!-- Delete button -->
      <div class="mt-6 pt-4" style="border-top: 1px solid var(--border);">
        <button onclick="deleteCurrentTask()" class="btn-danger">Delete task</button>
      </div>
    </div>
  </div>
</div>

<script>
// --- Theme ---
function getResolvedTheme(mode) {
  if (mode === 'auto') return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  return mode;
}

function setTheme(mode) {
  localStorage.setItem('wallfacer-theme', mode);
  document.documentElement.setAttribute('data-theme', getResolvedTheme(mode));
  document.querySelectorAll('#theme-switch button').forEach(function(btn) {
    btn.classList.toggle('active', btn.dataset.mode === mode);
  });
}

(function() {
  var mode = localStorage.getItem('wallfacer-theme') || 'auto';
  document.querySelectorAll('#theme-switch button').forEach(function(btn) {
    btn.classList.toggle('active', btn.dataset.mode === mode);
  });
})();

window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function() {
  var mode = localStorage.getItem('wallfacer-theme') || 'auto';
  if (mode === 'auto') document.documentElement.setAttribute('data-theme', getResolvedTheme('auto'));
});

// --- Settings panel ---
function toggleSettings(e) {
  e.stopPropagation();
  document.getElementById('settings-panel').classList.toggle('hidden');
}

document.addEventListener('click', function(e) {
  var panel = document.getElementById('settings-panel');
  var btn = document.getElementById('settings-btn');
  if (!panel.contains(e.target) && !btn.contains(e.target)) {
    panel.classList.add('hidden');
  }
});

// --- State ---
let tasks = [];
let currentTaskId = null;
let logsAbort = null;
let showArchived = localStorage.getItem('wallfacer-show-archived') === 'true';

// --- API ---
async function api(path, opts = {}) {
  const res = await fetch(path, {
    headers: { 'Content-Type': 'application/json' },
    ...opts,
  });
  if (!res.ok && res.status !== 204) {
    const text = await res.text();
    throw new Error(text);
  }
  if (res.status === 204) return null;
  return res.json();
}

async function fetchTasks() {
  try {
    const url = showArchived ? '/api/tasks?include_archived=true' : '/api/tasks';
    tasks = await api(url);
    render();
  } catch (e) {
    console.error('fetch tasks:', e);
  }
}

function toggleShowArchived() {
  showArchived = document.getElementById('show-archived-toggle').checked;
  localStorage.setItem('wallfacer-show-archived', showArchived ? 'true' : 'false');
  fetchTasks();
}

async function createTask() {
  const textarea = document.getElementById('new-prompt');
  const prompt = textarea.value.trim();
  if (!prompt) {
    textarea.focus();
    textarea.style.borderColor = '#dc2626';
    setTimeout(() => textarea.style.borderColor = '', 2000);
    return;
  }
  try {
    const timeout = parseInt(document.getElementById('new-timeout').value, 10) || 5;
    await api('/api/tasks', { method: 'POST', body: JSON.stringify({ prompt, timeout }) });
    hideNewTaskForm();
    fetchTasks();
  } catch (e) {
    alert('Error creating task: ' + e.message);
  }
}

function showNewTaskForm() {
  document.getElementById('new-task-btn').classList.add('hidden');
  document.getElementById('new-task-form').classList.remove('hidden');
  const textarea = document.getElementById('new-prompt');
  textarea.value = '';
  textarea.style.height = '';
  textarea.focus();
}

function hideNewTaskForm() {
  document.getElementById('new-task-form').classList.add('hidden');
  document.getElementById('new-task-btn').classList.remove('hidden');
  const textarea = document.getElementById('new-prompt');
  textarea.value = '';
  textarea.style.height = '';
}

async function updateTaskStatus(id, status) {
  try {
    await api(`/api/tasks/${id}`, { method: 'PATCH', body: JSON.stringify({ status }) });
    fetchTasks();
  } catch (e) {
    alert('Error updating task: ' + e.message);
  }
}

async function deleteTask(id) {
  try {
    await api(`/api/tasks/${id}`, { method: 'DELETE' });
    fetchTasks();
  } catch (e) {
    alert('Error deleting task: ' + e.message);
  }
}

async function submitFeedback() {
  const textarea = document.getElementById('modal-feedback');
  const message = textarea.value.trim();
  if (!message || !currentTaskId) return;
  try {
    await api(`/api/tasks/${currentTaskId}/feedback`, {
      method: 'POST',
      body: JSON.stringify({ message }),
    });
    textarea.value = '';
    closeModal();
    fetchTasks();
  } catch (e) {
    alert('Error submitting feedback: ' + e.message);
  }
}

async function completeTask() {
  if (!currentTaskId) return;
  try {
    await api(`/api/tasks/${currentTaskId}/done`, { method: 'POST' });
    closeModal();
    fetchTasks();
  } catch (e) {
    alert('Error completing task: ' + e.message);
  }
}

async function retryTask() {
  const textarea = document.getElementById('modal-retry-prompt');
  const prompt = textarea.value.trim();
  if (!prompt || !currentTaskId) return;
  try {
    await api(`/api/tasks/${currentTaskId}`, {
      method: 'PATCH',
      body: JSON.stringify({ status: 'backlog', prompt }),
    });
    closeModal();
    fetchTasks();
  } catch (e) {
    alert('Error retrying task: ' + e.message);
  }
}

async function resumeTask() {
  if (!currentTaskId) return;
  try {
    await api(`/api/tasks/${currentTaskId}/resume`, { method: 'POST' });
    closeModal();
    fetchTasks();
  } catch (e) {
    alert('Error resuming task: ' + e.message);
  }
}

let editDebounce = null;
function scheduleBacklogSave() {
  const statusEl = document.getElementById('modal-edit-status');
  statusEl.textContent = '';
  clearTimeout(editDebounce);
  editDebounce = setTimeout(async () => {
    if (!currentTaskId) return;
    const prompt = document.getElementById('modal-edit-prompt').value.trim();
    if (!prompt) return;
    const timeout = parseInt(document.getElementById('modal-edit-timeout').value, 10) || 5;
    try {
      await api(`/api/tasks/${currentTaskId}`, {
        method: 'PATCH',
        body: JSON.stringify({ prompt, timeout }),
      });
      statusEl.textContent = 'Saved';
      setTimeout(() => { if (statusEl.textContent === 'Saved') statusEl.textContent = ''; }, 1500);
      fetchTasks();
    } catch (e) {
      statusEl.textContent = 'Save failed';
    }
  }, 500);
}
document.getElementById('modal-edit-prompt').addEventListener('input', scheduleBacklogSave);
document.getElementById('modal-edit-timeout').addEventListener('change', scheduleBacklogSave);

function deleteCurrentTask() {
  if (!currentTaskId) return;
  if (!confirm('Delete this task?')) return;
  deleteTask(currentTaskId);
  closeModal();
}

async function archiveTask() {
  if (!currentTaskId) return;
  try {
    await api(`/api/tasks/${currentTaskId}/archive`, { method: 'POST' });
    closeModal();
    fetchTasks();
  } catch (e) {
    alert('Error archiving task: ' + e.message);
  }
}

async function unarchiveTask() {
  if (!currentTaskId) return;
  try {
    await api(`/api/tasks/${currentTaskId}/unarchive`, { method: 'POST' });
    closeModal();
    fetchTasks();
  } catch (e) {
    alert('Error unarchiving task: ' + e.message);
  }
}

// --- Markdown helpers ---
function renderMarkdown(text) {
  if (!text) return '';
  if (typeof marked === 'undefined') return escapeHtml(text);
  return marked.parse(text);
}

function renderMarkdownInline(text) {
  if (!text) return '';
  if (typeof marked === 'undefined') return escapeHtml(text);
  return marked.parseInline(text);
}

function toggleModalSection(section) {
  const renderedEl = document.getElementById('modal-' + section + '-rendered');
  const rawEl = document.getElementById('modal-' + section);
  const btn = document.getElementById('toggle-' + section + '-btn');
  const showingRaw = !rawEl.classList.contains('hidden');
  if (showingRaw) {
    renderedEl.classList.remove('hidden');
    rawEl.classList.add('hidden');
    btn.textContent = 'Raw';
  } else {
    renderedEl.classList.add('hidden');
    rawEl.classList.remove('hidden');
    btn.textContent = 'Preview';
  }
}

function copyModalText(section) {
  const rawEl = document.getElementById('modal-' + section);
  const text = rawEl.textContent;
  const btn = document.getElementById('copy-' + section + '-btn');
  navigator.clipboard.writeText(text).then(function() {
    const origHTML = btn.innerHTML;
    btn.textContent = 'Copied!';
    setTimeout(function() { btn.innerHTML = origHTML; }, 1500);
  }).catch(function() {});
}

function toggleCardMarkdown(event, btn) {
  event.stopPropagation();
  const card = btn.closest('.card');
  const renderedEls = card.querySelectorAll('.card-md-rendered');
  const rawEls = card.querySelectorAll('.card-md-raw');
  const nowShowingRaw = card.dataset.rawView === 'true';
  if (nowShowingRaw) {
    card.dataset.rawView = 'false';
    renderedEls.forEach(function(el) { el.classList.remove('hidden'); });
    rawEls.forEach(function(el) { el.classList.add('hidden'); });
    btn.textContent = 'Raw';
  } else {
    card.dataset.rawView = 'true';
    renderedEls.forEach(function(el) { el.classList.add('hidden'); });
    rawEls.forEach(function(el) { el.classList.remove('hidden'); });
    btn.textContent = 'Preview';
  }
}

function copyCardText(event, taskId) {
  event.stopPropagation();
  const task = tasks.find(function(t) { return t.id === taskId; });
  if (!task) return;
  const text = task.prompt + (task.result ? '\n\n' + task.result : '');
  const btn = event.currentTarget;
  navigator.clipboard.writeText(text).then(function() {
    const origHTML = btn.innerHTML;
    btn.textContent = '\u2713';
    setTimeout(function() { btn.innerHTML = origHTML; }, 1500);
  }).catch(function() {});
}

// --- Rendering ---
function render() {
  const columns = { backlog: [], in_progress: [], waiting: [], committing: [], done: [], failed: [] };
  for (const t of tasks) {
    const col = columns[t.status];
    if (col) col.push(t);
  }

  // Committing tasks show in the Waiting column with a spinner
  columns.waiting = columns.waiting.concat(columns.committing);
  delete columns.committing;

  for (const [status, items] of Object.entries(columns)) {
    const el = document.getElementById(`col-${status}`);
    if (!el) continue;
    const countEl = document.getElementById(`count-${status}`);
    if (countEl) countEl.textContent = items.length;

    const existing = new Map();
    for (const child of el.children) {
      existing.set(child.dataset.id, child);
    }

    const newIds = new Set(items.map(t => t.id));

    // Remove cards that are no longer in this column
    for (const [id, child] of existing) {
      if (!newIds.has(id)) child.remove();
    }

    // Add or update cards
    for (let i = 0; i < items.length; i++) {
      const t = items[i];
      let card = existing.get(t.id);
      if (!card) {
        card = createCard(t);
        el.appendChild(card);
      } else {
        updateCard(card, t);
      }
    }
  }

  // Update done column usage stats
  const doneStatsEl = document.getElementById('done-stats');
  if (doneStatsEl) {
    const doneItems = columns.done || [];
    const totalInput = doneItems.reduce(function(s, t) { return s + (t.usage && t.usage.input_tokens || 0); }, 0);
    const totalOutput = doneItems.reduce(function(s, t) { return s + (t.usage && t.usage.output_tokens || 0); }, 0);
    const totalCost = doneItems.reduce(function(s, t) { return s + (t.usage && t.usage.cost_usd || 0); }, 0);
    if (totalInput || totalOutput || totalCost) {
      doneStatsEl.textContent = totalInput.toLocaleString() + ' in / ' + totalOutput.toLocaleString() + ' out / $' + totalCost.toFixed(4);
      doneStatsEl.classList.remove('hidden');
    } else {
      doneStatsEl.classList.add('hidden');
    }
  }
}

function createCard(t) {
  const card = document.createElement('div');
  card.className = 'card';
  card.dataset.id = t.id;
  card.onclick = () => openModal(t.id);
  updateCard(card, t);
  return card;
}

function formatTimeout(minutes) {
  if (!minutes) return '5m';
  if (minutes < 60) return minutes + 'm';
  if (minutes % 60 === 0) return (minutes / 60) + 'h';
  return Math.floor(minutes / 60) + 'h' + (minutes % 60) + 'm';
}

function updateCard(card, t) {
  const isArchived = !!t.archived;
  const badgeClass = isArchived ? 'badge-archived' : `badge-${t.status}`;
  const statusLabel = isArchived ? 'archived' : (t.status === 'in_progress' ? 'in progress' : t.status === 'committing' ? 'committing' : t.status);
  const showSpinner = t.status === 'in_progress' || t.status === 'committing';
  card.style.opacity = isArchived ? '0.55' : '';
  const showingRaw = card.dataset.rawView === 'true';
  const copyIconSvg = `<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;
  card.innerHTML = `
    <div class="flex items-center justify-between mb-1">
      <div class="flex items-center gap-1.5">
        <span class="badge ${badgeClass}">${statusLabel}</span>
        ${showSpinner ? '<span class="spinner"></span>' : ''}
      </div>
      <div class="flex items-center gap-1.5">
        <button class="btn-icon" onclick="copyCardText(event, '${t.id}')" title="Copy to clipboard">${copyIconSvg}</button>
        <button class="btn-icon" onclick="toggleCardMarkdown(event, this)">${showingRaw ? 'Preview' : 'Raw'}</button>
        <span class="text-[10px] text-v-muted" title="Timeout">${formatTimeout(t.timeout)}</span>
        <span class="text-[10px] text-v-muted">${timeAgo(t.created_at)}</span>
      </div>
    </div>
    <div class="text-sm line-clamp-3 card-md-rendered${showingRaw ? ' hidden' : ''}">${renderMarkdownInline(t.prompt)}</div>
    <pre class="text-sm line-clamp-3 card-md-raw${showingRaw ? '' : ' hidden'}">${escapeHtml(t.prompt)}</pre>
    ${t.result ? `
    <div class="text-xs text-v-secondary mt-1 line-clamp-2 card-md-rendered${showingRaw ? ' hidden' : ''}">${renderMarkdownInline(t.result)}</div>
    <pre class="text-xs text-v-secondary mt-1 line-clamp-2 card-md-raw${showingRaw ? '' : ' hidden'}">${escapeHtml(t.result)}</pre>
    ` : ''}
  `;
}

function escapeHtml(s) {
  if (!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function timeAgo(dateStr) {
  const d = new Date(dateStr);
  const s = Math.floor((Date.now() - d) / 1000);
  if (s < 60) return 'just now';
  if (s < 3600) return Math.floor(s / 60) + 'm ago';
  if (s < 86400) return Math.floor(s / 3600) + 'h ago';
  return Math.floor(s / 86400) + 'd ago';
}

// --- Modal ---
async function openModal(id) {
  currentTaskId = id;
  const task = tasks.find(t => t.id === id);
  if (!task) return;

  document.getElementById('modal-badge').className = `badge badge-${task.status}`;
  document.getElementById('modal-badge').textContent = task.status === 'in_progress' ? 'in progress' : task.status;
  document.getElementById('modal-time').textContent = new Date(task.created_at).toLocaleString();
  const editSection = document.getElementById('modal-edit-section');
  if (task.status === 'backlog') {
    document.getElementById('modal-prompt').classList.add('hidden');
    editSection.classList.remove('hidden');
    document.getElementById('modal-edit-prompt').value = task.prompt;
    document.getElementById('modal-edit-timeout').value = String(task.timeout || 5);
  } else {
    document.getElementById('modal-prompt').classList.remove('hidden');
    document.getElementById('modal-prompt').textContent = task.prompt;
    editSection.classList.add('hidden');
  }

  const resultSection = document.getElementById('modal-result-section');
  if (task.result) {
    document.getElementById('modal-result').textContent = task.result;
    resultSection.classList.remove('hidden');
  } else {
    resultSection.classList.add('hidden');
  }

  // Usage stats (show when any tokens have been used)
  const usageSection = document.getElementById('modal-usage-section');
  const u = task.usage;
  if (u && (u.input_tokens || u.output_tokens || u.cost_usd)) {
    document.getElementById('modal-usage-input').textContent = u.input_tokens.toLocaleString();
    document.getElementById('modal-usage-output').textContent = u.output_tokens.toLocaleString();
    document.getElementById('modal-usage-cache-read').textContent = u.cache_read_input_tokens.toLocaleString();
    document.getElementById('modal-usage-cache-creation').textContent = u.cache_creation_input_tokens.toLocaleString();
    document.getElementById('modal-usage-cost').textContent = '$' + u.cost_usd.toFixed(4);
    usageSection.classList.remove('hidden');
  } else {
    usageSection.classList.add('hidden');
  }

  const logsSection = document.getElementById('modal-logs-section');
  if (task.status === 'in_progress') {
    logsSection.classList.remove('hidden');
    startLogStream(id);
  } else {
    logsSection.classList.add('hidden');
  }

  const feedbackSection = document.getElementById('modal-feedback-section');
  feedbackSection.classList.toggle('hidden', task.status !== 'waiting');

  // Resume section (failed with session_id only)
  const resumeSection = document.getElementById('modal-resume-section');
  if (task.status === 'failed' && task.session_id) {
    resumeSection.classList.remove('hidden');
  } else {
    resumeSection.classList.add('hidden');
  }

  // Retry section (done/failed only)
  const retrySection = document.getElementById('modal-retry-section');
  if (task.status === 'done' || task.status === 'failed') {
    retrySection.classList.remove('hidden');
    document.getElementById('modal-retry-prompt').value = task.prompt;
  } else {
    retrySection.classList.add('hidden');
  }

  // Archive/Unarchive section (done tasks only)
  const archiveSection = document.getElementById('modal-archive-section');
  const unarchiveSection = document.getElementById('modal-unarchive-section');
  if (task.status === 'done' && !task.archived) {
    archiveSection.classList.remove('hidden');
    unarchiveSection.classList.add('hidden');
  } else if (task.status === 'done' && task.archived) {
    archiveSection.classList.add('hidden');
    unarchiveSection.classList.remove('hidden');
  } else {
    archiveSection.classList.add('hidden');
    unarchiveSection.classList.add('hidden');
  }

  // Prompt history
  const historySection = document.getElementById('modal-history-section');
  if (task.prompt_history && task.prompt_history.length > 0) {
    historySection.classList.remove('hidden');
    const historyList = document.getElementById('modal-history-list');
    historyList.innerHTML = task.prompt_history.map((p, i) =>
      `<pre class="code-block text-xs" style="opacity:0.7;border:1px solid var(--border);"><span class="text-v-muted" style="font-size:10px;">#${i + 1}</span>\n${escapeHtml(p)}</pre>`
    ).join('');
  } else {
    historySection.classList.add('hidden');
  }

  // Load events
  try {
    const events = await api(`/api/tasks/${id}/events`);
    const container = document.getElementById('modal-events');
    container.innerHTML = events.map(e => {
      const time = new Date(e.created_at).toLocaleTimeString();
      let detail = '';
      const data = e.data || {};
      if (e.event_type === 'state_change') {
        detail = `${data.from || '(new)'} → ${data.to}`;
      } else if (e.event_type === 'feedback') {
        detail = `"${escapeHtml(data.message)}"`;
      } else if (e.event_type === 'output') {
        detail = `stop_reason: ${data.stop_reason || '(none)'}`;
      } else if (e.event_type === 'error') {
        detail = escapeHtml(data.error);
      }
      const typeClasses = {
        state_change: 'ev-state',
        output: 'ev-output',
        feedback: 'ev-feedback',
        error: 'ev-error',
      };
      return `<div class="flex items-start gap-2 text-xs">
        <span class="text-v-muted shrink-0">${time}</span>
        <span class="${typeClasses[e.event_type] || 'text-v-muted'} shrink-0">${e.event_type}</span>
        <span class="text-v-secondary">${detail}</span>
      </div>`;
    }).join('');
  } catch (e) {
    document.getElementById('modal-events').innerHTML = '<span class="text-xs ev-error">Failed to load events</span>';
  }

  document.getElementById('modal').classList.remove('hidden');
  document.getElementById('modal').classList.add('flex');
}

function closeModal() {
  if (logsAbort) {
    logsAbort.abort();
    logsAbort = null;
  }
  document.getElementById('modal-logs').textContent = '';
  currentTaskId = null;
  document.getElementById('modal').classList.add('hidden');
  document.getElementById('modal').classList.remove('flex');
}

function startLogStream(id) {
  if (logsAbort) logsAbort.abort();
  logsAbort = new AbortController();
  const logsEl = document.getElementById('modal-logs');
  logsEl.textContent = '';
  const decoder = new TextDecoder();
  const ansiRegex = /\x1b\[[0-9;]*[a-zA-Z]/g;

  fetch(`/api/tasks/${id}/logs`, { signal: logsAbort.signal })
    .then(res => {
      if (!res.ok || !res.body) return;
      const reader = res.body.getReader();
      function read() {
        reader.read().then(({ done, value }) => {
          if (done) return;
          const text = decoder.decode(value, { stream: true });
          const cleaned = text.replace(ansiRegex, '');
          logsEl.textContent += cleaned;
          logsEl.scrollTop = logsEl.scrollHeight;
          read();
        }).catch(() => {});
      }
      read();
    })
    .catch(() => {});
}

// Close modal on overlay click
document.getElementById('modal').addEventListener('click', (e) => {
  if (e.target === document.getElementById('modal')) closeModal();
});

// Close modal on Escape
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeModal();
});

// Textarea keyboard shortcuts & auto-grow
document.getElementById('new-prompt').addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
    e.preventDefault();
    createTask();
  }
  if (e.key === 'Escape') {
    e.preventDefault();
    hideNewTaskForm();
  }
});
document.getElementById('new-prompt').addEventListener('input', (e) => {
  e.target.style.height = '';
  e.target.style.height = e.target.scrollHeight + 'px';
});

// --- Drag and Drop ---
function initSortable() {
  const backlog = document.getElementById('col-backlog');
  const inProgress = document.getElementById('col-in_progress');

  // Backlog: can drag out
  Sortable.create(backlog, {
    group: { name: 'kanban', pull: true, put: false },
    animation: 150,
    ghostClass: 'sortable-ghost',
    chosenClass: 'sortable-chosen',
  });

  // In Progress: can receive from backlog
  Sortable.create(inProgress, {
    group: { name: 'kanban', pull: false, put: true },
    animation: 150,
    ghostClass: 'sortable-ghost',
    chosenClass: 'sortable-chosen',
    onAdd: function(evt) {
      const id = evt.item.dataset.id;
      updateTaskStatus(id, 'in_progress');
    },
  });

  // Waiting, Done, and Failed: no drag interaction
  Sortable.create(document.getElementById('col-waiting'), {
    group: { name: 'kanban', pull: false, put: false },
    animation: 150,
    sort: false,
  });
  Sortable.create(document.getElementById('col-done'), {
    group: { name: 'kanban', pull: false, put: false },
    animation: 150,
    sort: false,
  });
  Sortable.create(document.getElementById('col-failed'), {
    group: { name: 'kanban', pull: false, put: false },
    animation: 150,
    sort: false,
  });
}

// --- Git status ---
let gitStatuses = [];

async function fetchGitStatus() {
  try {
    gitStatuses = await api('/api/git/status');
    renderWorkspaces();
  } catch (e) {
    console.error('fetch git status:', e);
  }
}

function renderWorkspaces() {
  const el = document.getElementById('workspace-list');
  if (!gitStatuses || gitStatuses.length === 0) return;
  el.innerHTML = gitStatuses.map((ws, i) => {
    if (!ws.is_git_repo || !ws.has_remote) {
      return `<span title="${escapeHtml(ws.path)}" style="font-size: 11px; padding: 2px 8px; border-radius: 4px; background: var(--bg-input); color: var(--text-muted); border: 1px solid var(--border);">${escapeHtml(ws.name)}</span>`;
    }
    const branchLabel = ws.branch ? ` <span style="opacity:0.55;">${escapeHtml(ws.branch)}</span>` : '';
    const aheadBadge = ws.ahead_count > 0
      ? `<span style="background:var(--accent);color:#fff;border-radius:3px;padding:0 5px;font-size:10px;font-weight:600;line-height:17px;">${ws.ahead_count}↑</span>`
      : '';
    const pushBtn = ws.ahead_count > 0
      ? `<button data-ws-idx="${i}" onclick="pushWorkspace(this)" style="background:var(--accent);color:#fff;border:none;border-radius:3px;padding:1px 7px;font-size:10px;font-weight:500;cursor:pointer;line-height:17px;">Push</button>`
      : '';
    return `<span title="${escapeHtml(ws.path)}" style="display:inline-flex;align-items:center;gap:4px;font-size:11px;padding:2px 6px 2px 8px;border-radius:4px;background:var(--bg-input);color:var(--text-muted);border:1px solid var(--border);">${escapeHtml(ws.name)}${branchLabel}${aheadBadge}${pushBtn}</span>`;
  }).join('');
}

async function pushWorkspace(btn) {
  const idx = parseInt(btn.getAttribute('data-ws-idx'), 10);
  const ws = gitStatuses[idx];
  if (!ws) return;
  btn.disabled = true;
  btn.textContent = '...';
  try {
    await api('/api/git/push', { method: 'POST', body: JSON.stringify({ workspace: ws.path }) });
    fetchGitStatus();
  } catch (e) {
    alert('Push failed: ' + e.message);
    btn.disabled = false;
    btn.textContent = 'Push';
  }
}

// --- Init ---
try { initSortable(); } catch (e) { console.error('sortable init:', e); }
fetchGitStatus();
fetchTasks();
setInterval(fetchTasks, 2000);
setInterval(fetchGitStatus, 10000);
</script>
</body>
</html>
